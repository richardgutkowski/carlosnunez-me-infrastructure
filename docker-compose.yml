version: '3'
services:
  jenkins-master:
    build:
      context: .
      dockerfile: Dockerfile_jenkins_master
    image: local_jenkins_master
    ports:
      - "80:8080"
      - "50000:50000"
    env_file:
      - .env.jenkins-master
    user: jenkins
  jenkins-worker:
    image: jenkinsci/jnlp-slave
    environment:
      JENKINS_URL: 'http://jenkins-master:8080'
      JENKINS_SECRET: 'aaa12345'
      JENKINS_AGENT_NAME: 'jenkins-worker'
    external_links:
      - jenkins-master
    depends_on:
      - jenkins-master
    healthcheck:
      test: curl -f http://jenkins-master:8080
      interval: 30s
      timeout: 2s
      retries: 15
  pipeline-runner:
    build:
      context: .
      dockerfile: Dockerfile-pipeline_runner
    image: pipeline-runner
    depends_on:
      - jenkins-master
    healthcheck:
      test: curl -f http://jenkins-master:8080
      interval: 30s
      timeout: 2s
      retries: 15
